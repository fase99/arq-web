---
import type { Feature } from '@data/features';
import Button from '@components/ui/Button.astro';
import Eyebrow from '@components/ui/Eyebrow.astro';
import { Image } from 'astro:assets';
import { getPaddingClass, getBackgroundColor, getTextColor } from '@utils/styleUtils';
import type { PaddingSize, ThemeColor } from '@utils/styleUtils';

export interface Props {
    content: {
        eyebrow?: string;
        title?: string;
        description?: string;
        button?: {
            text: string;
            link: string;
            variant?: 'primary' | 'secondary' | 'ghostLight' | 'ghostDark';
        };
        features: Feature[];
    };
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
    carouselType?: 'swiper' | 'grid';
}

const {
    content: {
        eyebrow,
        title,
        description,
        button,
        features
    },
    background = 'base',
    carouselType = 'swiper'
} = Astro.props;

const bgColor = getBackgroundColor(background);
const textColor = getTextColor(background);
const paddingClass = getPaddingClass({ 
    padding: Astro.props.padding,
    paddingTop: Astro.props.paddingTop,
    paddingBottom: Astro.props.paddingBottom 
});
---

<section class:list={["relative", bgColor, paddingClass]}>
    <div class="site-container px-4">
        {(title || description) && (
            <div class="text-center mb-16 max-w-3xl mx-auto">
                {eyebrow && (
                    <Eyebrow 
                        text={eyebrow} 
                        background={background} 
                    />
                )}
                {title && (
                    <h2 class:list={[textColor]} data-aos="fade-up">
                        {title}
                    </h2>
                )}
                {description && (
                    <p class:list={["mt-4", textColor, "opacity-90"]} data-aos="fade-up" data-aos-delay="100">
                        {description}
                    </p>
                )}
                {button && (
                    <div class="mt-8" data-aos="fade-up" data-aos-delay="200">
                        <Button
                            href={button.link}
                            variant={button.variant || 'primary'}
                        >
                            {button.text}
                        </Button>
                    </div>
                )}
            </div>
        )}

        {carouselType === 'swiper' ? (
            <!-- Carousel Layout with Swiper -->
            <div class="features-carousel relative" data-aos="fade-up">
                <div class="swiper features-swiper">
                    <div class="swiper-wrapper">
                        {features.map((feature, index) => (
                            <div class="swiper-slide">
                                <div 
                                    class:list={[
                                        "h-full rounded-xl border border-gray-200 shadow-lg overflow-hidden",
                                        background === 'dark' ? 'bg-white/95' : 'bg-white',
                                        "flex flex-col",
                                        "transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",
                                        "mobile-feature-card"
                                    ]}
                                >
                                    {/* Image Section */}
                                    {feature.image && (
                                        <div class="feature-image-container h-48 overflow-hidden">
                                            <img
                                                src={typeof feature.image === 'string' ? feature.image : feature.image?.src}
                                                alt={feature.title}
                                                width={320}
                                                height={192}
                                                class="w-full h-full object-cover transition-transform duration-300 hover:scale-110"
                                                loading="lazy"
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Content Section */}
                                    <div class="p-5 sm:p-6 flex flex-col text-center">
                                        <div class:list={[
                                            "w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-lg mb-3 sm:mb-4 mx-auto",
                                            "bg-primary"
                                        ]}>
                                            <feature.icon
                                                size={24}
                                                class="text-white"
                                            />
                                        </div>
                                        <h3 class:list={["text-lg sm:text-xl mb-2 sm:mb-3", "text-gray-900", "font-semibold"]}>
                                            {feature.title}
                                        </h3>
                                        <p class:list={["text-sm leading-relaxed", "text-gray-700"]}>
                                            {feature.description}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <!-- Navigation -->
                    <div class="swiper-button-next features-next"></div>
                    <div class="swiper-button-prev features-prev"></div>
                    
                    <!-- Pagination -->
                    <div class="swiper-pagination features-pagination"></div>
                </div>
            </div>
        ) : (
            <!-- Grid Layout (fallback) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-auto-fit gap-8 auto-rows-fr">
                {features.map((feature, index) => (
                    <div 
                        class:list={[
                            "p-6 rounded-lg border border-gray-200 shadow-md",
                            background === 'dark' ? 'bg-white/95' : 'bg-white',
                            "flex flex-col"
                        ]}
                        data-aos="fade-up"
                        data-aos-delay={index * 100}
                    >
                        <div class:list={[
                            "w-12 h-12 flex items-center justify-center rounded-lg mb-4",
                            "bg-primary"
                        ]}>
                            <feature.icon
                                size={24}
                                class="text-white"
                            />
                        </div>
                        <h3 class:list={["text-h4 mb-2", "text-gray-900"]}>
                            {feature.title}
                        </h3>
                        <p class:list={["text-sm", "text-gray-700"]}>
                            {feature.description}
                        </p>
                    </div>
                ))}
            </div>
        )}
    </div>
</section>

<script>
    import { Swiper } from 'swiper';
    import { Navigation, Pagination, Autoplay } from 'swiper/modules';
    
    document.addEventListener('DOMContentLoaded', () => {
        const featuresSwiper = new Swiper('.features-swiper', {
            modules: [Navigation, Pagination, Autoplay],
            
            // Configuración básica
            direction: 'horizontal',
            loop: true,
            grabCursor: true,
            
            // Slides por vista y espaciado
            slidesPerView: 1,
            spaceBetween: 20,
            
            // Velocidad y efectos
            speed: 500,
            effect: 'slide',
            
            // Configuración táctil
            touchRatio: 1,
            touchAngle: 45,
            allowTouchMove: true,
            
            // Autoplay
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
                pauseOnMouseEnter: true,
            },
            
            // Navegación
            navigation: {
                nextEl: '.features-next',
                prevEl: '.features-prev',
            },
            
            // Paginación
            pagination: {
                el: '.features-pagination',
                clickable: true,
                dynamicBullets: true,
            },
            
            // Breakpoints responsivos
            breakpoints: {
                320: {
                    slidesPerView: 1,
                    spaceBetween: 16,
                },
                640: {
                    slidesPerView: 2,
                    spaceBetween: 20,
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 30,
                }
            },
            
            // Eventos
            on: {
                init: function() {
                    console.log('Swiper inicializado correctamente');
                },
                slideChange: function() {
                    // El slide cambió correctamente
                }
            }
        });

        // Control de hover para pausar autoplay
        const swiperEl = document.querySelector('.features-swiper');
        if (swiperEl) {
            swiperEl.addEventListener('mouseenter', () => {
                if (featuresSwiper.autoplay) {
                    featuresSwiper.autoplay.stop();
                }
            });
            
            swiperEl.addEventListener('mouseleave', () => {
                if (featuresSwiper.autoplay) {
                    featuresSwiper.autoplay.start();
                }
            });
        }
    });
</script>

<style>
    /* Import Swiper styles */
    @import 'swiper/css';
    @import 'swiper/css/navigation';
    @import 'swiper/css/pagination';

    .features-carousel {
        position: relative;
        max-width: 100%;
        overflow: hidden;
    }

    .features-swiper {
        width: 100%;
        padding: 40px 0;
    }

    .features-swiper .swiper-slide {
        height: auto;
        display: flex;
    }

    .features-swiper .swiper-slide > div {
        width: 100%;
        height: 100%;
    }

    /* Navigation buttons */
    .features-next,
    .features-prev {
        color: var(--color-primary) !important;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        width: 50px !important;
        height: 50px !important;
        margin-top: -25px !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .features-next:hover,
    .features-prev:hover {
        background: var(--color-primary);
        color: white !important;
        transform: scale(1.1);
    }

    .features-next::after,
    .features-prev::after {
        font-size: 18px !important;
        font-weight: bold;
    }

    /* Pagination */
    .features-pagination {
        position: relative !important;
        margin-top: 30px !important;
    }

    .features-pagination .swiper-pagination-bullet {
        width: 12px;
        height: 12px;
        background: var(--color-primary);
        opacity: 0.3;
        margin: 0 5px !important;
        transition: all 0.3s ease;
    }

    .features-pagination .swiper-pagination-bullet-active {
        opacity: 1;
        transform: scale(1.2);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .features-swiper {
            padding: 20px 0;
        }
        
        .features-next,
        .features-prev {
            width: 40px !important;
            height: 40px !important;
            margin-top: -20px !important;
        }
        
        .features-next::after,
        .features-prev::after {
            font-size: 14px !important;
        }
    }

    @media (max-width: 480px) {
        .features-next,
        .features-prev {
            width: 35px !important;
            height: 35px !important;
            margin-top: -17.5px !important;
        }
        
        .features-next::after,
        .features-prev::after {
            font-size: 12px !important;
        }
    }
</style>
