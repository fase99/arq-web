---
import type { Feature } from '@data/features';
import Button from '@components/ui/Button.astro';
import Eyebrow from '@components/ui/Eyebrow.astro';
import { Image } from 'astro:assets';
import { getPaddingClass, getBackgroundColor, getTextColor } from '@utils/styleUtils';
import type { PaddingSize, ThemeColor } from '@utils/styleUtils';

export interface Props {
    content: {
        eyebrow?: string;
        title?: string;
        description?: string;
        button?: {
            text: string;
            link: string;
            variant?: 'primary' | 'secondary' | 'ghostLight' | 'ghostDark';
        };
        features: Feature[];
    };
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
    carouselType?: 'swiper' | 'grid';
}

const {
    content: {
        eyebrow,
        title,
        description,
        button,
        features
    },
    background = 'base',
    carouselType = 'swiper'
} = Astro.props;

const bgColor = getBackgroundColor(background);
const textColor = getTextColor(background);
const paddingClass = getPaddingClass({ 
    padding: Astro.props.padding,
    paddingTop: Astro.props.paddingTop,
    paddingBottom: Astro.props.paddingBottom 
});
---

<section class:list={["relative", bgColor, paddingClass]}>
    <div class="site-container px-4">
        {(title || description) && (
            <div class="text-center mb-16 max-w-3xl mx-auto">
                {eyebrow && (
                    <Eyebrow 
                        text={eyebrow} 
                        background={background} 
                    />
                )}
                {title && (
                    <h2 class:list={[textColor]} data-aos="fade-up">
                        {title}
                    </h2>
                )}
                {description && (
                    <p class:list={["mt-4", textColor, "opacity-90"]} data-aos="fade-up" data-aos-delay="100">
                        {description}
                    </p>
                )}
                {button && (
                    <div class="mt-8" data-aos="fade-up" data-aos-delay="200">
                        <Button
                            href={button.link}
                            variant={button.variant || 'primary'}
                        >
                            {button.text}
                        </Button>
                    </div>
                )}
            </div>
        )}

        {carouselType === 'swiper' ? (
            <!-- Carousel Layout with Swiper -->
            <div class="features-carousel relative" data-aos="fade-up">
                <div class="swiper features-swiper">
                    <div class="swiper-wrapper">
                        {features.map((feature, index) => (
                            <div class="swiper-slide">
                                <div 
                                    class:list={[
                                        "h-full rounded-xl border border-gray-200 shadow-lg overflow-hidden",
                                        background === 'dark' ? 'bg-white/95' : 'bg-white',
                                        "flex flex-col",
                                        "transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",
                                        "mobile-feature-card"
                                    ]}
                                >
                                    {/* Image Section */}
                                    {feature.image && (
                                        <div class="feature-image-container h-48 overflow-hidden">
                                            <img
                                                src={typeof feature.image === 'string' ? feature.image : feature.image?.src}
                                                alt={feature.title}
                                                width={320}
                                                height={192}
                                                class="w-full h-full object-cover transition-transform duration-300 hover:scale-110"
                                                loading="lazy"
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Content Section */}
                                    <div class="p-5 sm:p-6 flex flex-col text-center">
                                        <div class:list={[
                                            "w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-lg mb-3 sm:mb-4 mx-auto",
                                            "bg-primary"
                                        ]}>
                                            <feature.icon
                                                size={24}
                                                class="text-white"
                                            />
                                        </div>
                                        <h3 class:list={["text-lg sm:text-xl mb-2 sm:mb-3", "text-gray-900", "font-semibold"]}>
                                            {feature.title}
                                        </h3>
                                        <p class:list={["text-sm leading-relaxed", "text-gray-700"]}>
                                            {feature.description}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <!-- Navigation -->
                    <div class="swiper-button-next features-next"></div>
                    <div class="swiper-button-prev features-prev"></div>
                    
                    <!-- Pagination -->
                    <div class="swiper-pagination features-pagination"></div>
                </div>
            </div>
        ) : (
            <!-- Grid Layout (fallback) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-auto-fit gap-8 auto-rows-fr">
                {features.map((feature, index) => (
                    <div 
                        class:list={[
                            "p-6 rounded-lg border border-gray-200 shadow-md",
                            background === 'dark' ? 'bg-white/95' : 'bg-white',
                            "flex flex-col"
                        ]}
                        data-aos="fade-up"
                        data-aos-delay={index * 100}
                    >
                        <div class:list={[
                            "w-12 h-12 flex items-center justify-center rounded-lg mb-4",
                            "bg-primary"
                        ]}>
                            <feature.icon
                                size={24}
                                class="text-white"
                            />
                        </div>
                        <h3 class:list={["text-h4 mb-2", "text-gray-900"]}>
                            {feature.title}
                        </h3>
                        <p class:list={["text-sm", "text-gray-700"]}>
                            {feature.description}
                        </p>
                    </div>
                ))}
            </div>
        )}
    </div>
</section>

<script>
    import { Swiper } from 'swiper';
    import { Navigation, Pagination, Autoplay } from 'swiper/modules';
    
    // Initialize Swiper when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        // Verificar si estamos en móvil
        const isMobile = window.innerWidth < 768;
        
        const featuresSwiper = new Swiper('.features-swiper', {
            modules: [Navigation, Pagination, Autoplay],
            grabCursor: true,
            centeredSlides: isMobile,
            slidesPerView: 'auto',
            spaceBetween: isMobile ? 16 : 30,
            loop: true,
            loopAdditionalSlides: 2,
            touchEventsTarget: 'container',
            touchRatio: 1,
            touchAngle: 45,
            threshold: 5,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
                pauseOnMouseEnter: true,
                stopOnLastSlide: false,
                waitForTransition: true,
            },
            pagination: {
                el: '.features-pagination',
                clickable: true,
                dynamicBullets: true,
            },
            navigation: {
                nextEl: '.features-next',
                prevEl: '.features-prev',
                hideOnClick: false,
            },
            breakpoints: {
                0: {
                    slidesPerView: 1,
                    spaceBetween: 16,
                    centeredSlides: true,
                },
                480: {
                    slidesPerView: 1.2,
                    spaceBetween: 20,
                    centeredSlides: true,
                },
                640: {
                    slidesPerView: 1.8,
                    spaceBetween: 20,
                    centeredSlides: true,
                },
                768: {
                    slidesPerView: 2,
                    spaceBetween: 25,
                    centeredSlides: false,
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 30,
                    centeredSlides: false,
                },
                1280: {
                    slidesPerView: 3,
                    spaceBetween: 35,
                    centeredSlides: false,
                }
            }
        });
        
        // Add hover pause functionality
        const swiperContainer = document.querySelector('.features-swiper');
        if (swiperContainer) {
            swiperContainer.addEventListener('mouseenter', () => {
                featuresSwiper.autoplay.stop();
            });
            
            swiperContainer.addEventListener('mouseleave', () => {
                featuresSwiper.autoplay.start();
            });
        }
        
        // Manejar eventos de cambio de tamaño y orientación
        let resizeTimer: ReturnType<typeof setTimeout> | undefined;
        window.addEventListener('resize', () => {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                featuresSwiper.updateSize();
                featuresSwiper.updateSlides();
                featuresSwiper.updateProgress();
                featuresSwiper.updateSlidesClasses();
                featuresSwiper.slideTo(featuresSwiper.activeIndex);
            }, 250);
        });
        
        // Mejorar comportamiento en dispositivos táctiles
        if ('ontouchstart' in window) {
            // Prevenir que las interacciones con las flechas de navegación inicien un desplazamiento
            document.querySelectorAll('.features-next, .features-prev').forEach(el => {
                el.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                });
            });
        }
    });
</script>

<style>
    /* Import Swiper styles */
    @import 'swiper/css';
    @import 'swiper/css/navigation';
    @import 'swiper/css/pagination';

    .features-carousel {
        position: relative;
        margin: 0 auto;
        max-width: 100%;
        overflow: hidden;
    }

    .features-swiper {
        width: 100%;
        padding: 50px 0;
    }

    .features-swiper .swiper-slide {
        width: 320px;
        height: auto;
        min-height: 380px;
        max-height: 450px;
    }

    /* Custom navigation buttons */
    .features-next,
    .features-prev {
        color: var(--color-primary) !important;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        width: 55px !important;
        height: 55px !important;
        margin-top: -27.5px !important;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        z-index: 10;
    }

    .features-next:hover,
    .features-prev:hover {
        background: var(--color-primary);
        color: white !important;
        transform: scale(1.15);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .features-next::after,
    .features-prev::after {
        font-size: 20px !important;
        font-weight: bold;
    }

    /* Custom pagination */
    .features-pagination {
        position: relative !important;
        margin-top: 40px !important;
    }

    .features-pagination .swiper-pagination-bullet {
        width: 14px;
        height: 14px;
        background: var(--color-primary);
        opacity: 0.4;
        transition: all 0.3s ease;
        margin: 0 6px !important;
    }

    .features-pagination .swiper-pagination-bullet-active {
        opacity: 1;
        transform: scale(1.3);
        background: var(--color-primary);
    }

    /* Enhanced slide styles */
    .swiper-slide {
        transition: all 0.3s ease;
    }

    .swiper-slide:hover {
        transform: translateY(-5px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .features-swiper {
            padding: 20px 0;
            overflow: visible;
        }
        
        .features-swiper .swiper-slide {
            width: 90%;
            min-height: 360px;
            height: auto;
            max-height: none;
        }
        
        .features-next,
        .features-prev {
            width: 40px !important;
            height: 40px !important;
            margin-top: -20px !important;
            opacity: 0.8;
        }
        
        .features-next::after,
        .features-prev::after {
            font-size: 16px !important;
        }
        
        .features-pagination {
            margin-top: 30px !important;
        }
        
        .features-pagination .swiper-pagination-bullet {
            width: 10px;
            height: 10px;
            margin: 0 4px !important;
        }
    }

    @media (max-width: 640px) {
        .features-swiper {
            padding: 15px 0;
        }
        
        .features-swiper .swiper-slide {
            width: 85%;
            min-height: 320px;
        }
        
        .features-next,
        .features-prev {
            width: 36px !important;
            height: 36px !important;
            margin-top: -18px !important;
            transform: translateX(0);
        }
        
        .features-next {
            right: 5px;
        }
        
        .features-prev {
            left: 5px;
        }
    }

    @media (max-width: 480px) {
        .features-carousel {
            margin: 0 -8px;
            width: calc(100% + 16px);
        }
        
        .features-swiper {
            padding: 10px 0;
        }
        
        .features-swiper .swiper-slide {
            width: 280px;
            min-height: 340px;
        }
        
        .features-next,
        .features-prev {
            width: 32px !important;
            height: 32px !important;
            margin-top: -16px !important;
            background: rgba(255, 255, 255, 0.85);
        }
        
        .features-next::after,
        .features-prev::after {
            font-size: 14px !important;
        }
        
        /* Mejorar el toque en móvil */
        .swiper-wrapper {
            touch-action: pan-y;
        }
    }

    /* Grid layout fallback styles */
    .grid-cols-auto-fit {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    /* Mejoras para experiencia móvil */
    .mobile-feature-card {
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        will-change: transform;
    }
    
    /* Optimización del clic/toque en móvil */
    @media (max-width: 768px) {
        .swiper-button-next.swiper-button-disabled,
        .swiper-button-prev.swiper-button-disabled {
            opacity: 0.2;
        }
        
        /* Mejorar accesibilidad de controles en táctil */
        .features-next, 
        .features-prev {
            opacity: 0.75;
            pointer-events: auto;
        }
        
        .features-next:active, 
        .features-prev:active {
            transform: scale(1.1);
        }
        
        /* Ajustes para mejorar la fluidez del desplazamiento */
        .features-swiper .swiper-slide {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
    }
</style>
